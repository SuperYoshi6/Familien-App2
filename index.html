<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familien PWA — Demo</title>
  <meta name="description" content="Familien-PWA: Login (Benutzername+Passwort), Kalender, News, Wetter, To‑Dos, Hausarbeiten, Essen, Dark Mode, Feedback, Admin." />

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CDN for quick styling (prototype) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { primary: { DEFAULT: '#4F46E5', dark: '#4338CA' }, accent: '#F59E0B' },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,.08)' }
        }
      }
    };
  </script>

  <style>
    /* THEME TOKENS */
    :root{--bg:#F6F7FB;--card:#ffffff;--text:#0B1220;--muted:#64748b;--line:#e5e7eb;--chip:#0b1220;--chipA:.06}
    [data-theme="dark"]{--bg:#0b1220;--card:#0f172a;--text:#E5E7EB;--muted:#94a3b8;--line:#1f2937;--chip:#e5e7eb;--chipA:.08}

    html,body{height:100%}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);background:var(--bg)}

    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(2,6,23,0.08);border:1px solid var(--line)}
    .chip{font-size:.75rem;padding:.2rem .5rem;border-radius:999px;background:color-mix(in oklab, var(--chip) var(--chipA*100%), transparent)}

    /* Dark-mode hardening for native elements */
    input, textarea, select, dialog, summary, details, .border{background:transparent;color:var(--text);border-color:var(--line)!important}
    input, textarea, select{background:color-mix(in oklab, var(--card) 96%, transparent)}
    dialog{background:var(--card);border:1px solid var(--line)}
    summary{list-style:none}
    summary::-webkit-details-marker{display:none}

    /* Sidebar */
    .sidebar{position:fixed;inset:0 auto 0 0;width:270px;background:var(--card);border-right:1px solid var(--line);transform:translateX(-100%);transition:transform .25s ease;z-index:40}
    .sidebar.open{transform:translateX(0)}
    .backdrop{position:fixed;inset:0;background:rgba(2,6,23,.4);backdrop-filter:saturate(1.2) blur(2px);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:30}
    .backdrop.show{opacity:1;pointer-events:auto}
    @media (min-width: 1024px){
      .sidebar{transform:translateX(0)}
      .backdrop{display:none}
      .with-sidebar{padding-left:280px}
    }

    /* Calendar cells */
    .cal-cell{background:color-mix(in oklab, var(--card) 94%, transparent);border:1px solid var(--line);border-radius:12px;min-height:110px;padding:.5rem;cursor:pointer}
    .cal-cell:hover{outline:2px solid color-mix(in oklab, var(--text) 10%, transparent)}
  </style>
</head>
<body class="min-h-screen">
  <div id="app" class="max-w-6xl mx-auto p-4 md:p-6">
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3 mb-6">
      <div class="flex items-center gap-3">
        <button id="btn-menu" class="px-3 py-2 rounded-lg border lg:hidden" aria-label="Menü öffnen">☰</button>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">🏡 Familien PWA — Demo</h1>
          <p class="text-sm text-slate-500">Benutzername & Passwort Auth — Demo‑Account wird einmalig angelegt</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-theme" class="px-3 py-2 rounded-lg border">🌓 Theme</button>
        <button id="btn-install" class="px-3 py-2 rounded-lg bg-indigo-600 text-white hidden">➕ Install</button>
        <button id="btn-logout" class="px-3 py-2 rounded-lg bg-rose-600 text-white hidden">🚪 Logout</button>
      </div>
    </header>

    <!-- SIDEBAR NAV -->
    <aside id="sidebar" class="sidebar">
      <div class="p-4 border-b flex items-center justify-between">
        <div class="font-semibold">Bereiche</div>
        <button id="btn-close-sidebar" class="lg:hidden px-3 py-1 rounded-lg border" aria-label="Menü schließen">✕</button>
      </div>
      <nav class="p-3 space-y-2">
        <button data-tab="family-cal" class="w-full text-left px-3 py-2 rounded-lg border">👪 Familienkalender</button>
        <button data-tab="my-cal" class="w-full text-left px-3 py-2 rounded-lg border">📅 Mein Kalender</button>
        <button data-tab="news" class="w-full text-left px-3 py-2 rounded-lg border">📰 News</button>
        <button data-tab="weather" class="w-full text-left px-3 py-2 rounded-lg border">🌦 Wetter</button>
        <button data-tab="todos" class="w-full text-left px-3 py-2 rounded-lg border">✅ To‑Dos</button>
        <button data-tab="chores" class="w-full text-left px-3 py-2 rounded-lg border">🧹 Hausarbeiten</button>
        <button data-tab="food" class="w-full text-left px-3 py-2 rounded-lg border">🍽️ Essen</button>
        <button data-tab="settings" class="w-full text-left px-3 py-2 rounded-lg border">⚙️ Einstellungen</button>
        <button data-tab="admin" id="tab-admin" class="w-full text-left px-3 py-2 rounded-lg bg-amber-500 text-white hidden">🛡 Admin</button>
      </nav>
    </aside>
    <div id="backdrop" class="backdrop"></div>

    <!-- AUTH -->
    <section id="auth" class="card p-5 mb-6">
      <div class="grid md:grid-cols-3 gap-3">
        <div class="md:col-span-2">
          <h2 class="text-lg font-semibold mb-2">Anmelden</h2>
          <form id="form-login" class="grid grid-cols-1 gap-2">
            <input id="login-username" placeholder="Benutzername" class="p-3 rounded-lg border" required />
            <input id="login-password" type="password" placeholder="Passwort" class="p-3 rounded-lg border" required />
            <div class="flex gap-2">
              <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white" type="submit">Login</button>
              <button id="open-register" type="button" class="px-4 py-2 rounded-lg border">Registrieren</button>
            </div>
          </form>
        </div>
        <div class="hidden md:block md:col-span-1"> 
          <h3 class="font-medium">Demo</h3>
          <div class="text-sm text-slate-500">Benutzername: <strong>demo</strong><br/>Passwort: <strong>demo123</strong></div>
          <div class="mt-3 text-xs text-slate-400">Hinweis: Demo wird einmalig beim ersten Start erstellt.</div>
        </div>
      </div>

      <dialog id="dlg-register" class="rounded-2xl p-0 w-full max-w-lg">
        <form id="form-register" method="dialog" class="p-5 space-y-3">
          <h3 class="text-xl font-semibold">Erstregistrierung</h3>
          <input id="reg-username" placeholder="Benutzername" class="p-3 rounded-lg border w-full" required />
          <input id="reg-password" type="password" placeholder="Passwort" class="p-3 rounded-lg border w-full" required />
          <label class="block text-sm">Rolle</label>
          <div class="flex gap-3">
            <label class="flex items-center gap-2"><input type="radio" name="reg-role" value="eltern" required/> Elternteil</label>
            <label class="flex items-center gap-2"><input type="radio" name="reg-role" value="kind"/> Kind</label>
            <label class="flex items-center gap-2"><input type="radio" name="reg-role" value="admin"/> Admin</label>
          </div>
          <div class="flex gap-2">
            <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white" type="submit">Konto anlegen</button>
            <button class="px-4 py-2 rounded-lg border" type="button" onclick="document.getElementById('dlg-register').close()">Abbrechen</button>
          </div>
        </form>
      </dialog>
    </section>

    <!-- TABS -->
    <main id="tabs" class="space-y-6 hidden with-sidebar">
      <!-- Familienkalender -->
      <section data-panel="family-cal" class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">👪 Familienkalender</h2>
          <div class="flex items-center gap-2">
            <button id="prev-month" class="px-3 py-2 rounded-lg border">←</button>
            <div id="month-label" class="font-medium"></div>
            <button id="next-month" class="px-3 py-2 rounded-lg border">→</button>
          </div>
        </div>
        <div id="month-grid" class="grid grid-cols-7 gap-2 mt-3"></div>
        <details class="mt-4">
          <summary class="cursor-pointer">Neuen Termin eintragen</summary>
          <form id="form-event" class="grid md:grid-cols-2 gap-3 mt-2">
            <input id="evt-title" placeholder="Titel" class="p-3 rounded-lg border" required />
            <input id="evt-who" placeholder="Wen betrifft es? (Benutzernamen, Komma)" class="p-3 rounded-lg border" />
            <input id="evt-start" type="datetime-local" class="p-3 rounded-lg border" required />
            <input id="evt-end" type="datetime-local" class="p-3 rounded-lg border" required />
            <textarea id="evt-desc" placeholder="Beschreibung" class="p-3 rounded-lg border md:col-span-2"></textarea>
            <button class="md:col-span-2 px-4 py-2 rounded-lg bg-indigo-600 text-white">Speichern</button>
          </form>
        </details>
      </section>

      <!-- Quick-Add Dialog -->
      <dialog id="dlg-quick-event" class="rounded-2xl p-0 w-full max-w-md">
        <form id="form-quick" method="dialog" class="p-5 space-y-3">
          <h3 class="text-lg font-semibold">Termin hinzufügen</h3>
          <div class="grid grid-cols-2 gap-2">
            <input id="q-title" placeholder="Titel" class="p-3 rounded-lg border col-span-2" required />
            <input id="q-date" type="date" class="p-3 rounded-lg border" required />
            <input id="q-start" type="time" class="p-3 rounded-lg border" value="09:00" required />
            <input id="q-end" type="time" class="p-3 rounded-lg border" value="10:00" required />
          </div>
          <input id="q-who" placeholder="Wen betrifft es? (Benutzernamen, Komma)" class="p-3 rounded-lg border w-full" />
          <textarea id="q-desc" placeholder="Beschreibung" class="p-3 rounded-lg border w-full h-24"></textarea>
          <div class="flex gap-2">
            <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white" type="submit">Speichern</button>
            <button class="px-4 py-2 rounded-lg border" type="button" onclick="document.getElementById('dlg-quick-event').close()">Abbrechen</button>
          </div>
        </form>
      </dialog>

      <!-- Mein Kalender -->
      <section data-panel="my-cal" class="card p-5">
        <h2 class="text-xl font-semibold">📅 Mein Kalender</h2>
        <ul id="my-events" class="mt-3 space-y-2"></ul>
      </section>

      <!-- News -->
      <section data-panel="news" class="card p-5">
        <h2 class="text-xl font-semibold">📰 News</h2>
        <form id="form-news" class="grid md:grid-cols-2 gap-3 mt-2">
          <input id="news-title" placeholder="Titel" class="p-3 rounded-lg border" required />
          <input id="news-tags" placeholder="#Tags (Komma)" class="p-3 rounded-lg border" />
          <textarea id="news-body" placeholder="Text" class="p-3 rounded-lg border md:col-span-2"></textarea>
          <input id="news-image" type="file" accept="image/*" class="md:col-span-2" />
          <button class="md:col-span-2 px-4 py-2 rounded-lg bg-indigo-600 text-white">Artikel veröffentlichen</button>
        </form>
        <div id="news-list" class="grid md:grid-cols-2 gap-4 mt-4"></div>
      </section>

      <!-- Wetter -->
      <section data-panel="weather" class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">🌦 Wetter — Alzey</h2>
          <div class="text-sm text-slate-500" id="weather-update"></div>
        </div>
        <div id="weather-now" class="mt-3"></div>
        <div id="weather-7" class="mt-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-7 gap-3"></div>
      </section>

      <!-- ToDos -->
      <section data-panel="todos" class="card p-5">
        <h2 class="text-xl font-semibold">✅ Persönliche To‑Dos</h2>
        <form id="form-todo" class="flex gap-2 mt-2">
          <input id="todo-text" placeholder="Neue Aufgabe" class="p-3 rounded-lg border flex-1" />
          <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Hinzufügen</button>
        </form>
        <ul id="todo-list" class="mt-3 space-y-2"></ul>
      </section>

      <!-- Hausarbeiten -->
      <section data-panel="chores" class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">🧹 Hausarbeiten</h2>
          <span id="role-badge" class="text-sm opacity-80"></span>
        </div>
        <details class="mt-2" id="chore-create">
          <summary class="cursor-pointer select-none">Neue Hausarbeit (nur Eltern)</summary>
          <form id="form-chore" class="grid md:grid-cols-2 gap-3 mt-2">
            <input id="chore-title" placeholder="Titel" class="p-3 rounded-lg border" required />
            <select id="chore-prio" class="p-3 rounded-lg border">
              <option value="niedrig">Niedrig</option>
              <option value="mittel">Mittel</option>
              <option value="hoch">Hoch</option>
            </select>
            <input id="chore-due" type="date" class="p-3 rounded-lg border" />
            <input id="chore-assigned" placeholder="Wer? (Benutzernamen, Komma)" class="p-3 rounded-lg border" />
            <button class="md:col-span-2 px-4 py-2 rounded-lg bg-indigo-600 text-white">Speichern</button>
          </form>
        </details>
        <ul id="chore-list" class="mt-3 space-y-2"></ul>
      </section>

      <!-- Essen -->
      <section data-panel="food" class="card p-5">
        <h2 class="text-xl font-semibold">🍽️ Essensbestellung</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <form id="form-food" class="space-y-2">
            <input id="food-items" placeholder="Was möchtest du essen?" class="p-3 rounded-lg border w-full" />
            <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Bestellen</button>
          </form>
          <div>
            <h3 class="font-semibold">Offene Bestellungen (Elternansicht)</h3>
            <ul id="food-orders" class="mt-2 space-y-2"></ul>
          </div>
        </div>
      </section>

      <!-- Einstellungen -->
      <section data-panel="settings" class="card p-5">
        <h2 class="text-xl font-semibold">⚙️ Einstellungen</h2>
        <div class="flex items-center gap-3 mt-2">
          <label class="flex items-center gap-2"><input type="checkbox" id="toggle-dark" /> Dark Mode</label>
          <button id="btn-feedback" class="px-3 py-2 rounded-lg border">Feedback senden</button>
          <button id="btn-save-sw" class="px-3 py-2 rounded-lg border" title="sw.js lokal speichern">sw.js herunterladen</button>
        </div>
        <dialog id="dlg-feedback" class="rounded-2xl p-0 w-full max-w-lg">
          <form id="form-feedback" method="dialog" class="p-5 space-y-3">
            <h3 class="text-xl font-semibold">Feedback</h3>
            <textarea id="feedback-text" placeholder="Was sollen wir verbessern?" class="p-3 rounded-lg border w-full h-36"></textarea>
            <div class="flex gap-2">
              <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white" type="submit">Senden</button>
              <button class="px-4 py-2 rounded-lg border" type="button" onclick="document.getElementById('dlg-feedback').close()">Schließen</button>
            </div>
          </form>
        </dialog>
        <details class="mt-6">
          <summary class="cursor-pointer select-none font-medium">📦 SQL Schema für Supabase (zum Kopieren)</summary>
          <pre id="sql-block" class="text-xs overflow-x-auto p-3 bg-slate-900 text-slate-100 rounded-xl mt-2"></pre>
        </details>
      </section>

      <!-- Admin -->
      <section data-panel="admin" class="card p-5">
        <h2 class="text-xl font-semibold">🛡️ Admin</h2>
        <p class="text-sm text-slate-500">Admins können Passwörter setzen und Feedback einsehen.</p>
        <div class="grid md:grid-cols-2 gap-4 mt-3">
          <form id="form-reset-pass" class="space-y-2">
            <input id="reset-username" placeholder="Benutzername" class="p-3 rounded-lg border w-full" />
            <input id="reset-password" type="password" placeholder="Neues Passwort" class="p-3 rounded-lg border w-full" />
            <button class="px-4 py-2 rounded-lg bg-amber-500 text-white">Passwort setzen</button>
          </form>
          <div>
            <h3 class="font-semibold">📬 Nutzerfeedback</h3>
            <ul id="feedback-list" class="mt-2 space-y-2"></ul>
          </div>
        </div>
      </section>

    </main>

    <footer class="mt-8 text-center text-sm text-slate-400">Demo PWA — passe SUPABASE_URL und SUPABASE_ANON_KEY in der Datei an.</footer>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_isoWeek);</script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>

  <!-- Make bcrypt available as `bcrypt` (bcryptjs exposes dcodeIO.bcrypt) -->
  <script>
    if (typeof window.bcrypt === 'undefined') {
      if (window.dcodeIO && window.dcodeIO.bcrypt) {
        window.bcrypt = window.dcodeIO.bcrypt;
      } else if (window.bcrypt) {
        /* ok */
      } else {
        console.warn('bcryptjs wurde nicht gefunden — Passwortfunktionen werden fehlschlagen.');
      }
    }
  </script>

  <script>
    // ---------------- CONFIG ----------------
    const SUPABASE_URL = 'https://hjkmfodzhradtkeiyele.supabase.co'; // <-- setze hier deine Werte
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhqa21mb2R6aHJhZHRrZWl5ZWxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0ODIwNjEsImV4cCI6MjA2ODA1ODA2MX0.2cfezsLcT6x3KI9VqzrHntP80O-cy0JQUb7UK3Mnai8';
    const WEATHER_API_KEY = 'a00136db1232d2004edd6421151bd519';
    const WEATHER_CITY = 'Alzey,de';

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------------- SIDEBAR ----------------
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('backdrop');
    document.getElementById('btn-menu').addEventListener('click', ()=>{ sidebar.classList.add('open'); backdrop.classList.add('show'); });
    document.getElementById('btn-close-sidebar').addEventListener('click', ()=>{ sidebar.classList.remove('open'); backdrop.classList.remove('show'); });
    backdrop.addEventListener('click', ()=>{ sidebar.classList.remove('open'); backdrop.classList.remove('show'); });

    // ---------------- THEME & PWA ----------------
    const root = document.documentElement;
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    function setTheme(mode){ root.setAttribute('data-theme', mode); localStorage.setItem('theme', mode); document.getElementById('toggle-dark').checked = (mode==='dark'); }
    setTheme(localStorage.getItem('theme') || (prefersDark? 'dark' : 'light'));
    document.getElementById('btn-theme').addEventListener('click', ()=> setTheme(root.getAttribute('data-theme')==='dark'?'light':'dark'));
    document.getElementById('toggle-dark').addEventListener('change', (e)=> setTheme(e.target.checked?'dark':'light'));

    // ServiceWorker registration: nur wenn sw.js auf dem Server liegt
    if('serviceWorker' in navigator && window.isSecureContext){ (async ()=>{ try{ const res = await fetch('./sw.js', { method: 'HEAD' }); if(res.ok) await navigator.serviceWorker.register('./sw.js'); }catch(e){ console.warn('SW skipped', e); } })(); }

    // Optional: SW-Datei herunterladen, damit du sie in dein Projekt legen kannst
    const SW_SOURCE = `// sw.js — einfacher Cache & Network-Fallback
const CACHE_NAME = 'familie-pwa-v1';
const ASSETS = ['/', './index.html'];
self.addEventListener('install', e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()))});
self.addEventListener('activate', e=>{e.waitUntil(self.clients.claim())});
self.addEventListener('fetch', event=>{ if(event.request.method!=='GET') return; event.respondWith(caches.match(event.request).then(r=> r || fetch(event.request).then(fr=>{ if(!fr || fr.status!==200 || fr.type!=='basic') return fr; const copy=fr.clone(); caches.open(CACHE_NAME).then(c=>c.put(event.request, copy)); return fr; }))) });`;
    document.getElementById('btn-save-sw').addEventListener('click', ()=>{ const blob=new Blob([SW_SOURCE],{type:'text/javascript'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sw.js'; a.click(); URL.revokeObjectURL(a.href); alert('sw.js wurde heruntergeladen. Lege die Datei in dein Projekt‑Root und lade die Seite über HTTPS.'); });

    // ---------------- SIMPLE SESSION ----------------
    const session = {
      get(){ try{return JSON.parse(localStorage.getItem('session')) || null;}catch{return null;} },
      set(obj){ localStorage.setItem('session', JSON.stringify(obj)); },
      clear(){ localStorage.removeItem('session'); }
    };

    const elAuth = document.getElementById('auth');
    const tabs = document.getElementById('tabs');
    const logoutBtn = document.getElementById('btn-logout');
    const roleBadge = document.getElementById('role-badge');

    // ---------------- DEMO ACCOUNT ----------------
    async function ensureDemoAccount(){
      try{
        const { data } = await sb.from('users').select('*').eq('username','demo').limit(1);
        if(!data || data.length===0){
          if(!window.bcrypt){ console.error('bcrypt nicht verfügbar. Demo-Account kann nicht angelegt werden.'); return; }
          const pwHash = bcrypt.hashSync('demo123', 10);
          await sb.from('users').insert([{ username: 'demo', password_hash: pwHash, role: 'eltern' }]);
        }
      }catch(err){ console.error(err); }
    }

    // ---------------- AUTH: register/login ----------------
    document.getElementById('open-register').addEventListener('click', ()=> document.getElementById('dlg-register').showModal());

    document.getElementById('form-register').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const role = Array.from(document.querySelectorAll('[name="reg-role"]')).find(r=>r.checked)?.value;
      if(!username||!password||!role){ alert('Bitte alles ausfüllen'); return; }
      if(!window.bcrypt){ alert('Passwort-Funktionen sind nicht verfügbar.'); return; }
      const pwHash = bcrypt.hashSync(password, 10);
      const { error } = await sb.from('users').insert([{ username, password_hash: pwHash, role }]);
      if(error){ alert('Registrierung fehlgeschlagen: '+ error.message); return; }
      alert('Registrierung erfolgreich');
      document.getElementById('dlg-register').close();
    });

    document.getElementById('form-login').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const { data, error } = await sb.from('users').select('*').eq('username', username).limit(1);
      if(error){ alert('Fehler beim Login'); console.warn(error); return; }
      if(!data || data.length===0){ alert('Benutzer nicht gefunden'); return; }
      const user = data[0];
      if(!window.bcrypt){ alert('Passwort-Funktionen sind nicht verfügbar.'); return; }
      const ok = bcrypt.compareSync(password, user.password_hash);
      if(!ok){ alert('Falsches Passwort'); return; }
      session.set({ id: user.id, username: user.username, role: user.role });
      await afterLogin();
    });

    logoutBtn.addEventListener('click', ()=>{ session.clear(); location.reload(); });

    async function afterLogin(){
      const user = session.get(); if(!user) return;
      document.getElementById('tab-admin').classList.toggle('hidden', user.role!=='admin');
      roleBadge.textContent = `Deine Rolle: ${user.role}`;
      elAuth.classList.add('hidden');
      tabs.classList.remove('hidden');
      logoutBtn.classList.remove('hidden');
      loadMonth(currentMonth);
      loadMyEvents();
      loadNews();
      loadTodos();
      loadChores();
      loadOrders();
      loadWeather();
    }

    if(session.get()) afterLogin();

    // ---------------- TABS via SIDEBAR ----------------
    document.querySelectorAll('#sidebar [data-tab]').forEach(btn=> btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll('[data-panel]').forEach(p=> p.classList.toggle('hidden', p.dataset.panel!==tab));
      sidebar.classList.remove('open'); backdrop.classList.remove('show');
    }));

    // ---------------- CALENDAR ----------------
    const monthLabel = document.getElementById('month-label');
    const monthGrid = document.getElementById('month-grid');
    let currentMonth = dayjs().startOf('month');

    function renderMonth(date){
      monthGrid.innerHTML = '';
      monthLabel.textContent = date.format('MMMM YYYY');
      const start = date.startOf('month');
      const end = date.endOf('month');
      const offset = (start.day()+6)%7;
      for(let i=0;i<offset;i++){ monthGrid.appendChild(document.createElement('div')); }
      for(let d=1; d<=end.date(); d++){
        const dayDate = start.date(d);
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        cell.title = 'Klicken um Termin hinzuzufügen';
        cell.addEventListener('click', ()=> openQuickAdd(dayDate));
        const head = document.createElement('div'); head.className='text-xs text-slate-500 flex items-center justify-between';
        head.innerHTML = `<span>${dayDate.format('dd, DD.')}</span>`;
        const list = document.createElement('ul'); list.className='mt-2 space-y-1 text-sm';
        cell.appendChild(head); cell.appendChild(list); monthGrid.appendChild(cell);
      }
    }

    async function loadMonth(date){
      renderMonth(date);
      const start = date.startOf('month').toISOString();
      const end = date.endOf('month').toISOString();
      const { data, error } = await sb.from('family_calendar').select('*').gte('start_date', start).lte('end_date', end).order('start_date');
      if(error) return console.warn(error);
      // place events
      const cells = Array.from(monthGrid.querySelectorAll('.cal-cell'));
      data.forEach(evt=>{
        const idx = dayjs(evt.start_date).date()-1;
        const ul = cells[idx]?.querySelector('ul');
        if(ul){ const li = document.createElement('li'); li.innerHTML = `<strong>${evt.title}</strong><div class="text-xs text-slate-500">${dayjs(evt.start_date).format('HH:mm')}–${dayjs(evt.end_date).format('HH:mm')}</div>`; ul.appendChild(li); }
      });
    }

    document.getElementById('prev-month').addEventListener('click', ()=>{ currentMonth = currentMonth.subtract(1,'month'); loadMonth(currentMonth); });
    document.getElementById('next-month').addEventListener('click', ()=>{ currentMonth = currentMonth.add(1,'month'); loadMonth(currentMonth); });

    // Quick-Add helpers
    const dlgQuick = document.getElementById('dlg-quick-event');
    function openQuickAdd(dayDate){
      const d = dayDate || dayjs();
      document.getElementById('q-date').value = d.format('YYYY-MM-DD');
      document.getElementById('q-start').value = '09:00';
      document.getElementById('q-end').value = '10:00';
      document.getElementById('q-title').value = '';
      document.getElementById('q-who').value = '';
      document.getElementById('q-desc').value = '';
      dlgQuick.showModal();
    }

    document.getElementById('form-quick').addEventListener('submit', async (e)=>{
      e.preventDefault(); const user = session.get(); if(!user) return alert('Bitte einloggen');
      const title = document.getElementById('q-title').value.trim();
      const whoRaw = document.getElementById('q-who').value.trim();
      const whoNames = whoRaw? whoRaw.split(',').map(s=>s.trim()).filter(Boolean):[];
      let target_users = [];
      if(whoNames.length){ const res = await sb.from('users').select('id,username').in('username', whoNames); if(res.data) target_users = res.data.map(u=>u.id); }
      const date = document.getElementById('q-date').value;
      const start = document.getElementById('q-start').value;
      const end = document.getElementById('q-end').value;
      const start_date = new Date(`${date}T${start}`).toISOString();
      const end_date = new Date(`${date}T${end}`).toISOString();
      const description = document.getElementById('q-desc').value.trim();
      const { error } = await sb.from('family_calendar').insert([{ title, description, start_date, end_date, target_users, created_by: user.id }]);
      if(error) return alert('Fehler: '+ error.message);
      dlgQuick.close(); loadMonth(currentMonth); loadMyEvents();
    });

    document.getElementById('form-event').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const user = session.get(); if(!user) return alert('Bitte einloggen');
      const title = document.getElementById('evt-title').value.trim();
      const whoRaw = document.getElementById('evt-who').value.trim();
      const whoNames = whoRaw? whoRaw.split(',').map(s=>s.trim()).filter(Boolean):[];
      let target_users = [];
      if(whoNames.length){ const res = await sb.from('users').select('id,username').in('username', whoNames); if(res.data) target_users = res.data.map(u=>u.id); }
      const start_date = new Date(document.getElementById('evt-start').value).toISOString();
      const end_date = new Date(document.getElementById('evt-end').value).toISOString();
      const description = document.getElementById('evt-desc').value.trim();
      const { error } = await sb.from('family_calendar').insert([{ title, description, start_date, end_date, target_users, created_by: user.id }]);
      if(error) return alert('Fehler: '+ error.message);
      loadMonth(currentMonth); loadMyEvents(); e.target.reset();
    });

    async function loadMyEvents(){
      const user = session.get(); if(!user) return;
      const { data, error } = await sb.from('family_calendar').select('*').or(`created_by.eq.${user.id},target_users.cs.{${user.id}}`).order('start_date');
      if(error) return console.warn(error);
      const ul = document.getElementById('my-events'); ul.innerHTML='';
      data.forEach(evt=>{ const li=document.createElement('li'); li.className='p-3 rounded-lg border'; li.innerHTML=`<div class="font-medium">${evt.title}</div><div class="text-xs text-slate-500">${dayjs(evt.start_date).format('DD.MM.YYYY HH:mm')} – ${dayjs(evt.end_date).format('DD.MM.YYYY HH:mm')}</div><div>${evt.description||''}</div>`; ul.appendChild(li); });
    }

    // ---------------- NEWS ----------------
    document.getElementById('form-news').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const user = session.get(); if(!user) return alert('Bitte einloggen');
      const title = document.getElementById('news-title').value.trim();
      const tags = document.getElementById('news-tags').value.trim().split(',').map(t=>t.trim()).filter(Boolean);
      const content = document.getElementById('news-body').value.trim();
      const file = document.getElementById('news-image').files[0];
      let image_url = null;
      if(file){ const path = `news/${user.id}-${Date.now()}-${file.name}`; const up = await sb.storage.from('assets').upload(path, file); if(up.error) return alert(up.error.message); image_url = sb.storage.from('assets').getPublicUrl(path).data.publicUrl; }
      const { error } = await sb.from('news').insert([{ title, content, image_url, tags, created_by: user.id }]);
      if(error) return alert('Fehler: '+ error.message);
      loadNews(); e.target.reset();
    });

    async function loadNews(){
      const { data, error } = await sb.from('news').select('*').order('created_at', { ascending:false });
      if(error) return console.warn(error);
      const wrap = document.getElementById('news-list'); wrap.innerHTML='';
      data.forEach(n=>{ const card=document.createElement('article'); card.className='rounded-lg overflow-hidden border'; card.innerHTML=`${n.image_url?`<img src="${n.image_url}" class="w-full h-40 object-cover">`:''}<div class="p-3"><h3 class="font-semibold">${n.title}</h3><div class="text-xs text-slate-500 mb-2">${new Date(n.created_at).toLocaleString()}</div><p class="text-sm">${n.content}</p><div class="mt-2">${(n.tags||[]).map(t=>`<span class='chip mr-1'>${t}</span>`).join('')}</div></div>`; wrap.appendChild(card); });
    }

    // ---------------- WEATHER (Pixel Weather‑like) ----------------
    async function loadWeather(){
      try{
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(WEATHER_CITY)}&appid=${WEATHER_API_KEY}&units=metric&lang=de`);
        const cur = await res.json();
        const box = document.getElementById('weather-now');
        if(cur.cod!==200){ box.textContent='Wetter konnte nicht geladen werden.'; return; }
        document.getElementById('weather-update').textContent = new Date().toLocaleString();
        const icon = cur.weather?.[0]?.icon || '01d';
        box.innerHTML = `<div class="flex items-center gap-4"><img src="https://openweathermap.org/img/wn/${icon}@2x.png" width="64" height="64"/><div><div class="text-3xl font-bold">${Math.round(cur.main.temp)}°C</div><div class="text-sm text-slate-500">${cur.weather?.[0]?.description||''}</div><div class="text-xs text-slate-400">${cur.name}</div><div class="text-xs mt-1">gefühlte ${Math.round(cur.main.feels_like)}°C · ${Math.round(cur.main.temp_min)}° / ${Math.round(cur.main.temp_max)}°</div></div></div>`;

        // 7‑Tage Vorhersage via OneCall (Koordinaten aus current)
        const { lon, lat } = cur.coord;
        const res2 = await fetch(`https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&exclude=minutely,hourly,alerts&units=metric&lang=de&appid=${WEATHER_API_KEY}`);
        const oc = await res2.json();
        const grid = document.getElementById('weather-7'); grid.innerHTML='';
        (oc.daily||[]).slice(0,7).forEach(d=>{
          const dt = dayjs.unix(d.dt);
          const card = document.createElement('div');
          card.className='rounded-xl border p-3 text-center';
          card.innerHTML = `
            <div class="text-xs text-slate-500">${dt.format('dd')}</div>
            <img class="mx-auto" src="https://openweathermap.org/img/wn/${d.weather?.[0]?.icon||'01d'}.png" alt=""/>
            <div class="text-sm font-semibold">${Math.round(d.temp.max)}° / ${Math.round(d.temp.min)}°</div>
            <div class="text-xs">gefühlt ${Math.round(d.feels_like.day)}°</div>
          `;
          grid.appendChild(card);
        });
      }catch(e){ console.warn(e); }
    }

    // ---------------- TODOS ----------------
    document.getElementById('form-todo').addEventListener('submit', async (e)=>{
      e.preventDefault(); const user = session.get(); if(!user) return alert('Bitte einloggen');
      const task = document.getElementById('todo-text').value.trim(); if(!task) return;
      const { error } = await sb.from('todos').insert([{ task, user_id: user.id }]); if(error) return alert(error.message);
      document.getElementById('todo-text').value=''; loadTodos();
    });

    async function loadTodos(){
      const user = session.get(); if(!user) return; const { data, error } = await sb.from('todos').select('*').eq('user_id', user.id).order('created_at', {ascending:false}); if(error) return console.warn(error);
      const ul = document.getElementById('todo-list'); ul.innerHTML=''; data.forEach(t=>{ const li=document.createElement('li'); li.className='p-3 rounded-lg border flex items-center gap-2'; const cb=document.createElement('input'); cb.type='checkbox'; cb.checked = !!t.completed; cb.onchange = async ()=>{ await sb.from('todos').update({ completed: cb.checked }).eq('id', t.id); }; const span=document.createElement('span'); span.className='flex-1'; span.textContent=t.task; const del=document.createElement('button'); del.textContent='✖'; del.onclick=async ()=>{ await sb.from('todos').delete().eq('id', t.id); li.remove(); }; li.appendChild(cb); li.appendChild(span); li.appendChild(del); ul.appendChild(li); });
    }

    // ---------------- CHORES ----------------
    document.getElementById('form-chore').addEventListener('submit', async (e)=>{
      e.preventDefault(); const user = session.get(); if(!user) return alert('Bitte einloggen'); if(user.role!=='eltern' && user.role!=='admin') return alert('Nur Eltern/Admins');
      const title = document.getElementById('chore-title').value.trim(); const priority = document.getElementById('chore-prio').value; const due_date = document.getElementById('chore-due').value || null; const assRaw = document.getElementById('chore-assigned').value.trim(); const names = assRaw? assRaw.split(',').map(s=>s.trim()).filter(Boolean):[]; let assigned_users=[]; if(names.length){ const res = await sb.from('users').select('id,username').in('username', names); if(res.data) assigned_users = res.data.map(u=>u.id); }
      const { error } = await sb.from('chores').insert([{ title, priority, due_date, assigned_users, created_by: user.id }]); if(error) return alert(error.message);
      e.target.reset(); loadChores();
    });

    async function loadChores(){
      const { data, error } = await sb.from('chores').select('*').order('due_date'); if(error) return console.warn(error);
      const ul=document.getElementById('chore-list'); ul.innerHTML=''; data.forEach(c=>{ const li=document.createElement('li'); li.className='p-3 rounded-lg border'; const meta=`${c.priority?.toUpperCase()||''} ${c.due_date? '· fällig '+ new Date(c.due_date).toLocaleDateString():''}`; li.innerHTML=`<div class=\"font-medium\">${c.title}</div><div class=\"text-xs text-slate-500 mb-2\">${meta}</div>`; const btn=document.createElement('button'); btn.className='px-3 py-1 rounded-lg bg-emerald-600 text-white'; btn.textContent='Erledigt markieren'; btn.onclick=async ()=>{ await sb.from('chore_status').insert([{ chore_id: c.id }]); btn.disabled=true; btn.textContent='Erledigt'; }; li.appendChild(btn); if(Array.isArray(c.assigned_users) && c.assigned_users.length){ const small=document.createElement('div'); small.className='text-xs text-slate-500 mt-2'; small.textContent='Zugewiesen an '+c.assigned_users.length+' Nutzer'; li.appendChild(small); } ul.appendChild(li); });
    }

    // ---------------- FOOD ----------------
    document.getElementById('form-food').addEventListener('submit', async (e)=>{
      e.preventDefault(); const user = session.get(); if(!user) return alert('Bitte einloggen'); const meal = document.getElementById('food-items').value.trim(); if(!meal) return; const { error } = await sb.from('meals').insert([{ meal_name: meal, ordered_by: user.id }]); if(error) return alert(error.message); document.getElementById('food-items').value=''; loadOrders();
    });

    async function loadOrders(){
      const { data, error } = await sb.from('meals').select('*').order('created_at', {ascending:false}); if(error) return console.warn(error); const ul=document.getElementById('food-orders'); ul.innerHTML=''; data.forEach(o=>{ const li=document.createElement('li'); li.className='p-3 rounded-lg border flex items-center justify-between'; li.innerHTML=`<div><div class=\"font-medium\">${o.meal_name}</div><div class=\"text-xs text-slate-500\">${new Date(o.created_at).toLocaleString()}</div></div>`; ul.appendChild(li); });
    }

    // ---------------- FEEDBACK / ADMIN ----------------
    document.getElementById('btn-feedback').addEventListener('click', ()=> document.getElementById('dlg-feedback').showModal());
    document.getElementById('form-feedback').addEventListener('submit', async (e)=>{ e.preventDefault(); const user = session.get(); if(!user) return alert('Bitte einloggen'); const msg = document.getElementById('feedback-text').value.trim(); if(!msg) return; const { error } = await sb.from('feedback').insert([{ message: msg, created_by: user.id }]); if(error) return alert(error.message); document.getElementById('dlg-feedback').close(); alert('Danke'); });

    document.getElementById('form-reset-pass').addEventListener('submit', async (e)=>{ e.preventDefault(); const user = session.get(); if(!user || user.role!=='admin') return alert('Nur Admin'); const uname = document.getElementById('reset-username').value.trim(); const npass = document.getElementById('reset-password').value; const pwHash = bcrypt.hashSync(npass, 10); const { error } = await sb.from('users').update({ password_hash: pwHash }).eq('username', uname); if(error) return alert(error.message); alert('Passwort gesetzt'); });

    async function loadFeedback(){ const user = session.get(); if(!user || user.role!=='admin') return; const { data, error } = await sb.from('feedback').select('*').order('created_at', {ascending:false}); if(error) return console.warn(error); const ul = document.getElementById('feedback-list'); ul.innerHTML=''; data.forEach(f=>{ const li=document.createElement('li'); li.className='p-3 rounded-lg border'; li.innerHTML=`<div>${f.message}</div><div class=\"text-xs text-slate-500 mt-1\">${new Date(f.created_at).toLocaleString()}</div>`; ul.appendChild(li); }); }

    // ---------------- SQL SCHEMA ----------------
    const SQL = `-- SCHEMA (kopieren in Supabase SQL Editor)

create table if not exists users (
  id uuid primary key default gen_random_uuid(),
  username text unique not null,
  password_hash text not null,
  role text check (role in ('eltern','kind','admin')) not null
);

create table if not exists family_calendar (
  id uuid primary key default gen_random_uuid(),
  title text not null,
  description text,
  start_date timestamptz not null,
  end_date timestamptz not null,
  target_users uuid[] default '{}',
  created_by uuid references users(id)
);

create table if not exists news (
  id uuid primary key default gen_random_uuid(),
  title text not null,
  content text not null,
  image_url text,
  tags text[] default '{}',
  created_by uuid references users(id),
  created_at timestamptz default now()
);

create table if not exists todos (
  id uuid primary key default gen_random_uuid(),
  task text not null,
  completed boolean default false,
  user_id uuid references users(id),
  created_at timestamptz default now()
);

create type chore_priority as enum ('niedrig','mittel','hoch');
create table if not exists chores (
  id uuid primary key default gen_random_uuid(),
  title text not null,
  description text,
  priority chore_priority not null default 'niedrig',
  due_date date,
  assigned_users uuid[] default '{}',
  created_by uuid references users(id),
  created_at timestamptz default now()
);

create table if not exists chore_status (
  id uuid primary key default gen_random_uuid(),
  chore_id uuid references chores(id) on delete cascade,
  user_id uuid references users(id) on delete cascade,
  status text default 'done',
  completed_at timestamptz default now()
);

create table if not exists meals (
  id uuid primary key default gen_random_uuid(),
  meal_name text not null,
  ordered_by uuid references users(id),
  created_at timestamptz default now()
);

create table if not exists feedback (
  id uuid primary key default gen_random_uuid(),
  message text not null,
  created_by uuid references users(id),
  created_at timestamptz default now()
);
`;
    document.getElementById('sql-block').textContent = SQL;

    // ---------------- BOOT ----------------
    (async function boot(){
      await ensureDemoAccount();
      if(session.get()) await afterLogin();
    })();

  </script>

</body>
</html>
